// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© RVD-Projects

import RVD-Projects/Types/3
import RVD-Projects/Functions/2

import TradingView/ta/9
import PineCoders/Time/5
import RVD-Projects/TradeManager/5

// @version=6
// @link RVD-Projects/Intra-VWAP/1
// @description IVWAP Strategy

// # ========================================================================= #
// #                   |   STRATEGY  |
// # ========================================================================= #
strategy(
 title                           = "IVWAP Strategy",
 shorttitle                      = "ST-IVWAP",
 overlay                         =  true,
 behind_chart                    =  true
//  format                          =  ,
//  precision                       =  ,
//  scale                           =  ,
//  pyramiding                      =  ,
//  calc_on_order_fills             =  ,
//  calc_on_every_tick              =  ,
//  max_bars_back                   =  ,
//  backtest_fill_limits_assumption =  ,
//  default_qty_type                =  ,
//  default_qty_value               =  ,
//  initial_capital                 =  ,
//  currency                        =  , 
//  slippage                        =  ,
//  commission_type                 =  , 
//  commission_value                =  ,
//  process_orders_on_close         =  ,
//  close_entries_rule              =  ,
//  margin_long                     =  ,
//  margin_short                    =  ,
//  explicit_plot_zorder            =  ,
//  max_lines_count                 =  ,
//  max_labels_count                =  ,
//  max_boxes_count                 =  ,
//  calc_bars_count                 =  ,
//  risk_free_rate                  =  ,
//  use_bar_magnifier               =  ,
//  fill_orders_on_standard_ohlc    =  ,
//  max_polylines_count             =  ,
//  dynamic_requests                =  ,
 )
// # ========================================================================= #
// #                   |   STRATEGY  |
// # ========================================================================= #

isNewPeriod = timeframe.change("D")
lowVWAP = ta.vwap(low, isNewPeriod)
highVWAP = ta.vwap(high, isNewPeriod)
middleVWAP = highVWAP - (highVWAP - lowVWAP) / 2

if na(low)
    isNewPeriod := true

// Time-based position management
currentHour = hour(time, "America/Toronto")
isFlattenWindow = currentHour >= 15 and currentHour < 18
mustFlatten = isFlattenWindow and strategy.position_size != 0

// Close all positions if we're in the 4PM-6PM window and have open trades
if (isFlattenWindow)
    if (mustFlatten)
        TradeManager.CloseAllOrders()
else
    // Long entry and exit conditions
    longEntry = ta.crossover(close, lowVWAP)
    longExitHigh = ta.crossover(close, highVWAP)
    longExitMiddle = ta.crossunder(close, middleVWAP)

    // Short entry and exit conditions
    shortEntry = ta.crossunder(close, highVWAP)
    shortExitLow = ta.crossunder(close, lowVWAP)
    shortExitMiddle = ta.crossover(close, middleVWAP)

    // Long trade management
    if (longEntry)
        strategy.entry("Long", strategy.long)

    if (longExitHigh or longExitMiddle)
        TradeManager.CloseOrder("Long", na, na)

    // Short trade management
    if (shortEntry)
        strategy.entry("Short", strategy.short)

    if (shortExitLow or shortExitMiddle)
        TradeManager.CloseOrder("Short", na, na)

plot(lowVWAP, color=color.fuchsia, title="Low")
plot(middleVWAP, color=color.aqua, title="Middle")
plot(highVWAP, color=color.fuchsia, title="High")

// Plot closing window background
bgcolor(isFlattenWindow ? color.new(color.red, 90) : na, title="Must Go Flat BG")

// Plot must go flat label
plotshape(mustFlatten ? close : na, title="Must Go Flat", location=location.top, style=shape.labeldown, text="All Positions Flat", textcolor=color.white, size=size.small, color=color.red)