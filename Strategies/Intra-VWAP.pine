// This Pine Script¬Æ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© RVD-Projects

import RVD-Projects/Types/3
import RVD-Projects/Functions/2

import TradingView/ta/9
import PineCoders/Time/5
import RVD-Projects/TradeManager/5

// @version=6
// @link RVD-Projects/Intra-VWAP/1
// @description IVWAP Strategy

// # ========================================================================= #
// #                   |   STRATEGY  |
// üéØ Concept Principal
// La strat√©gie utilise les VWAP Intra-day (Volume Weighted Average Price) pour cr√©er des zones de trading bas√©es sur les prix pond√©r√©s par le volume de la journ√©e.

// üìä
//  Calcul des VWAP
// 3 niveaux VWAP recalcul√©s chaque nouveau jour (timeframe.change("D"))
// Cr√©ent des zones de support/r√©sistance dynamiques
// üîÑ
//  R√®gles de Trading
// üìà
//  Positions LONGUES
// Entr√©e : Prix cl√¥ture > VWAP High (ta.crossover(close, highVWAP))
// Sortie : Prix cl√¥ture < VWAP Low (ta.crossunder(close, lowVWAP))
// üìâ
//  Positions COURTES
// Entr√©e : Prix cl√¥ture < VWAP Low (ta.crossunder(close, lowVWAP))
// Sortie : Prix cl√¥ture > VWAP High (ta.crossover(close, highVWAP))
// ‚è∞
//  Gestion du Temps
// üö´
//  Fen√™tre d'Interdiction (3PM-6PM Toronto)
// Aucune nouvelle position pendant cette p√©riode
// Fermeture forc√©e de toutes les positions existantes
// √âvite les mouvements de fin de s√©ance
// ‚è±Ô∏è
//  Limitation de D√©tention
// Maximum 6 heures de d√©tention par position
// Fermeture automatique si d√©pass√©
// Limite l'exposition au risque
// # ========================================================================= #

// # ========================================================================= #
// #                   |   STRATEGY  |
// # ========================================================================= #
strategy(
 title                           = "IVWAP Strategy",
 shorttitle                      = "ST-IVWAP",
 overlay                         =  true,
 behind_chart                    =  true,
 commission_value                =  2.00,
 initial_capital                 =  50000.00,
 currency                        =  currency.USD,
 commission_type                 =  strategy.commission.cash_per_contract
//  slippage                        =  ,
//  default_qty_type                =  ,
//  default_qty_value               =  ,
//  format                          =  ,
//  precision                       =  ,
//  scale                           =  ,
//  pyramiding                      =  ,
//  calc_on_order_fills             =  ,
//  calc_on_every_tick              =  ,
//  max_bars_back                   =  ,
//  backtest_fill_limits_assumption =  ,
//  process_orders_on_close         =  ,
//  close_entries_rule              =  ,
//  margin_long                     =  ,
//  margin_short                    =  ,
//  explicit_plot_zorder            =  ,
//  max_lines_count                 =  ,
//  max_labels_count                =  ,
//  max_boxes_count                 =  ,
//  calc_bars_count                 =  ,
//  risk_free_rate                  =  ,
//  use_bar_magnifier               =  ,
//  fill_orders_on_standard_ohlc    =  ,
//  max_polylines_count             =  ,
//  dynamic_requests                =  ,
 )
// # ========================================================================= #
// #                   |   STRATEGY  |
// # ========================================================================= #

hasPosition = strategy.position_size != 0
currentHour = hour(time, "America/Toronto")
isNewPeriod = timeframe.change("D") or na(low[1])
isNoTradeWindow = currentHour >= 15 and currentHour < 18
mustFlatten = isNoTradeWindow and hasPosition

var float lastTradeTime = na
// Check if position should be closed due to max holding time
shouldCloseHolding = hasPosition and not na(lastTradeTime) and (time - lastTradeTime) >= 6 * 60 * 60 * 1000

// VWAP calculations
lowVWAP = ta.vwap(low, isNewPeriod)
highVWAP = ta.vwap(high, isNewPeriod)
middleVWAP = highVWAP - (highVWAP - lowVWAP) / 2

// Long entry and exit conditions
longEntry = ta.crossover(close, highVWAP)
longExit = ta.crossunder(close, lowVWAP)

// Short entry and exit conditions
shortEntry = ta.crossunder(close, lowVWAP)
shortExit = ta.crossover(close, highVWAP)

// Force close positions that have been held for too long
if (shouldCloseHolding)
    TradeManager.CloseAllOrders()
    lastTradeTime := time

// Close all positions if we're in the 4PM-6PM window and have open trades
if (isNoTradeWindow)
    if (mustFlatten)
        TradeManager.CloseAllOrders()
        lastTradeTime := time
else
    // Long trade management
    if (longEntry)
        strategy.entry("Long", strategy.long)
        lastTradeTime := time

    if (longExit)
        TradeManager.CloseOrder("Long", na, na)
        lastTradeTime := time

    // Short trade management
    if (shortEntry)
        strategy.entry("Short", strategy.short)
        lastTradeTime := time

    if (shortExit)
        TradeManager.CloseOrder("Short", na, na)
        lastTradeTime := time

// Plot VWAP lines
plot(lowVWAP, color=color.fuchsia, title="Low")
plot(middleVWAP, color=color.aqua, title="Middle")
plot(highVWAP, color=color.fuchsia, title="High")

// Plot closing window background
bgcolor(isNoTradeWindow ? color.new(color.red, 90) : na, title="Non-Trading Window BG")

// Plot must go flat label
plotshape(mustFlatten ? close : na, title="Forced Flat", location=location.top, style=shape.labeldown, text="Forced Flat", textcolor=color.white, size=size.small, color=color.red)